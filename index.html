async function postService() {
  const spinner = document.getElementById("loadingSpinner");
  if (spinner) spinner.style.display = "flex";

  try {
    if (!currentUser) {
      showCustomAlert("Please login first.", "error");
      return;
    }

    const serviceCountSnap = await servicesRef.where("postedBy", "==", currentUser.uid).get();
    const totalServices = serviceCountSnap.size;

    if (totalServices >= 1) {
      const confirmPayment = confirm("You have already posted one free service. Pay Ksh 200 to post another. Proceed to payment?");
      if (!confirmPayment) return;
      await processServicePayment();
    }

    const name = document.getElementById("svcName").value.trim();
    const phone = document.getElementById("svcPhone").value.trim();
    const county = document.getElementById("svcCounty").value.trim();
    const occupation = document.getElementById("svcOccupation").value.trim();
    const experience = document.getElementById("svcExperience").value.trim();

    if (!name || !phone || !county || !occupation || !experience) {
      showCustomAlert("Please fill in all fields before posting.", "error");
      return;
    }

    let photoURLs = [];
    const photoInput = document.getElementById("svcPhotos");
    if (photoInput.files.length > 0) {
      const uploadPromises = Array.from(photoInput.files).map(async (file) => {
        const storageRef = firebase.storage().ref();
        const photoRef = storageRef.child(`services/${currentUser.uid}/${Date.now()}_${file.name}`);
        await photoRef.put(file);
        return await photoRef.getDownloadURL();
      });
      photoURLs = await Promise.all(uploadPromises);
    }

    await servicesRef.add({
      name,
      phone,
      county,
      occupation,
      experience,
      postedBy: currentUser.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      boosted: false,
      boostExpiry: null,
      photos: photoURLs
    });

    showCustomAlert("Service posted successfully!", "success");
    document.getElementById("serviceForm").reset();
    loadServices();

  } catch (error) {
    console.error("Error posting service:", error);
    showCustomAlert("Failed to post service. Please try again.", "error");
  } finally {
    if (spinner) spinner.style.display = "none";
  }
}
